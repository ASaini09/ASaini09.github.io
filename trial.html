<!DOCTYPE html>
<html>
    <head>

        <meta charset=utf-8 />

        <title>Geoweb Application</title>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <!-- leaflet -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
		integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
		crossorigin=""/>

		<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
		integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
		crossorigin=""></script>

        <!-- paho library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    </head>

    <body>

        <h2> Turn your smartphone into a IoT Sensor!</h2>


        <!-- MQTT broker connection settings form -->
        <form id="connection-settings">
            <label for="broker-host">MQTT Broker Host:</label>
            <input type="text" id="broker-host" name="broker-host" value="test.mosquitto.org">

            <label for="broker-port">MQTT Broker Port:</label>
            <input type="text" id="broker-port" name="broker-port" value="8081">

            <button type="button" onclick="connectToBroker()">Connect to Broker</button>
			<button type="button" onclick="disconnectFromBroker()">Disconnect From Broker</button>
        </form>

        <!-- Map container -->
        <div id="map" style="height: 500px;"></div>

        <!-- JavaScript code -->
        <script>
            var map;
            var client;

            // Set up Leaflet map
            function setupMap() {
                map = L.map('map').setView([51.05, -114.070], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(map);
            }

            // Connect to MQTT broker
            function connectToBroker() {
                var brokerHost = document.getElementById("broker-host").value.toString();
                var brokerPort = document.getElementById("broker-port").value;
				
				var clientId = "client_" + Math.random().toString(16).substr(2, 8);
                client = new Paho.MQTT.Client(brokerHost, parseInt(brokerPort), clientId);
                client.connect({onSuccess: onConnect});
            }
			
			function disconnectFromBroker() {
				client.disconnect();
				console.log("Disconnected from MQTT broker");
			
			}

            // Callback function called when MQTT client connects to broker
            function onConnect() {
                console.log("Connected to MQTT broker");

                // Subscribe to the topic where the location data will be published
                client.subscribe("geoweb/location");

                // Display marker on map when a new location message is received
                client.onMessageArrived = function(message) {
                    console.log("Received message: " + message.payloadString);
                    var location = JSON.parse(message.payloadString);

                    L.marker([location.lat, location.lon]).addTo(map);
                };
            }

            // Call setupMap() function when the page finishes loading
            window.onload = setupMap;
        </script>

    </body>

</html>
